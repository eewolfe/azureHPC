{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "mastervmname": {
        "type": "string",
        "metadata": {
          "description": "Name of the Master VM"
        }
      },
      "vmssName": {
        "type": "string",
        "metadata": {
          "description": "String used as a base for naming resources. Must be 3-61 characters in length and globally unique across Azure. A hash is prepended to this string for some resources, and resource-specific information is appended."
        },
        "maxLength": 61
      },
      "dnsLabelPrefix": {
        "type": "string",
        "metadata": {
          "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
        },
        "defaultValue": "[concat('msi',uniquestring(resourceGroup().id,deployment().name))]"
      },
      "location": {
        "type": "string",
        "metadata": {
          "description": "The Location For the resources"
        },
        "defaultValue": "[resourceGroup().location]"
      },
      "azureCLI2DockerImage": {
        "type": "string",
        "metadata": {
          "description": "The Docker image to rin the azure CLI from"
        },
        "defaultValue": "azuresdk/azure-cli-python:latest"
      },
      "_artifactsLocation": {
        "type": "string",
        "metadata": {
          "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
        },
        "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-vm-msi-linux"
      },
      "_artifactsLocationSasToken": {
        "type": "securestring",
        "metadata": {
          "description": "The sasToken required to access _artifactsLocation."
        },
        "defaultValue": ""
      }
    },
    "variables": {
      "storageAccountName": "[take(concat(uniquestring(resourceGroup().id), parameters('dnsLabelPrefix')),24)]",

      "containerName": "msi",
      "createRBACUrl": "[concat(parameters('_artifactsLocation'), '/setUpRBAC.json', parameters('_artifactsLocationSasToken'))]",
      "mastervmPrincipalID": "[concat(resourceId('Microsoft.Compute/virtualMachines/', parameters('mastervmname')),'/providers/Microsoft.ManagedIdentity/Identities/default')]"
    },
    "resources": [
      {
        "name": "creatingRBAC",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2016-09-01",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[variables('createRBACUrl')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "principalId": {
              "value": "[reference(variables('mastervmPrincipalID'),'2015-08-31-PREVIEW').principalId]"
            },
            "storageAccountName": {
              "value": "[variables('storageAccountName')]"
            },
            "vmssName": {
             "value": "[parameters('vmssName')]"
            }
          }
        }
      },
      {
        "name": "[concat(parameters('mastervmname'),'/customscriptextension')]",
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "apiVersion": "2017-03-30",
        "location": "[parameters('Location')]",
        "dependsOn": [
          "Microsoft.Resources/deployments/creatingRBAC"
        ],
        "properties": {
          "publisher": "Microsoft.Azure.Extensions",
          "type": "CustomScript",
          "typeHandlerVersion": "2.0",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "fileUris": [
              "[concat(parameters('_artifactsLocation'), '/scripts/writeblob.sh', parameters('_artifactsLocationSasToken'))]",
              "[concat(parameters('_artifactsLocation'), '/scripts/install-and-run-cli-2.sh', parameters('_artifactsLocationSasToken'))]"
            ]
          },
          "protectedSettings": {
            "commandToExecute": "[concat('./install-and-run-cli-2.sh -i \"', parameters('azureCLI2DockerImage'),'\" -a \"', variables('storageAccountName'), '\" -c \"', variables('containerName'), '\" -r \"', resourceGroup().Name,'\"')]"
          }
        }
      }
    ],
    "outputs": {

      "principalId": {
        "type": "string",
        "value": "[reference('Microsoft.Resources/deployments/creatingVM', '2016-09-01').outputs.principalId.value]"
      }
    }
  }
  